var token = " "; //token bot telegram
var url = "https://api.telegram.org/bot" + token;
var webAppUrl = " "; //alamat webhook
function setWebhook() {
    var response = UrlFetchApp.fetch(url + "/setWebhook?url=" + webAppUrl);
    Logger.log(response.getContentText());
  }

function doPost(e) {
  var stringJson = e.postData.getDataAsString();
  var updates = JSON.parse(stringJson);
  var id = updates.message.from.id;
  var nama = updates.message.from.first_name;
  var username = updates.message.from.username;
  var textBot = updates.message.text;
  var chat_bot = textBot;
  var command_cek = chat_bot.substring(0, 1);
  var command = chat_bot.split(" ")[0]; // command
  var subCommand = chat_bot.split(" ")[1]; // odp
 
  if (command_cek == "/") {
  switch(command){
    case "/formatjob" :
      let text2 = "Contoh Pengisian /job untuk GCU atau Repair : /job GCU - Done atau /job Repair SFP Pending ðŸ˜‰";
      sendText(id, text2);  
    break;
    case "/job" :
     simpan(updates);
    break;
    default:
    sendText(id,"Format salah !, gunakan command /formatjob untuk mengetahui sususan format yang benar ðŸ™‚");
  }
 } else {
    let eror ="Klik Menu untuk mengetahui semua command yang ada";
    sendText(id,error);
  }
 
}

function simpan(data) {
  let id = data.message.from.id;
  var nama = data.message.from.first_name;
  var username = data.message.from.username;
  var pesan = data.message.text;
  let text = pesan;
  var now = new Date();
  var waktu = Utilities.formatDate(now, "Asia/Jakarta", "dd/mm/yyyy hh:mm:ss"); // format timestamp indonesia

  var txt1 = text.split(" ")[0]; // kata pertama/command/janjji waktu / 2-06-2022 / menghadiri pernikahan
  var pekerjaan = text.split(" ")[1]; // kata kedua
  var perbaikan = text.split(" ")[2]; // kata kedua
  var status = text.split(" ")[3]; // kata ketiga

  var SSID = " "; //alamat spreadsheet untuk simpan
  var namasheet = " "; //nama sheet pada spreadsheet
  SpreadsheetApp.openById(SSID).getSheetByName(namasheet).appendRow([waktu, id, username, pekerjaan, perbaikan, status]); // input log
  sendText(id,"Data pekerjaan telah disimpan, Terimakasih ðŸ™‚");
}

function sendText(chatid, text, replymarkup) {
  var data = {
    method: "post",
    payload: {
      method: "sendMessage",
      chat_id: String(chatid),
      text: text,
      parse_mode: "HTML",
      reply_markup: JSON.stringify(replymarkup)
    }
  };
  UrlFetchApp.fetch('https://api.telegram.org/bot' + token + '/', data);
}
